<?php namespace ProcessWire;

class CookieMonster extends WireData implements Module, ConfigurableModule {

	public static function getModuleInfo() {
		return array(
			'title' => 'CookieMonster', 
			'version' => 102, 
			'summary' => 'Fulfills GDPR madness and renders a cookie banner above your site’s content.',
			'singular' => true, 
			'autoload' => true, 
			'icon' => 'github-alt',
			'author' => 'Johannes Dachsel' 
		);
	}
	
	protected static $defaults = array(
		'bodytext' => "Diese Website verwendet Cookies, um die Nutzerfreundlichkeit zu verbessern. Durch die weitere Nutzung der Website stimmen Sie dem zu. Weitere Informationen zu Cookies und deren Deaktivierung finden Sie unter Datenschutz. Diese Website verwendet das Tracking Tool Google Analytics, damit wir unsere Website bedarfsgerecht gestalten und fortlaufend optimieren können. Durch die weitere Nutzung der Website stimmen Sie dem zu. Weitere Informationen zu Tracking Tools und deren Deaktivierung finden Sie unter Datenschutz.",
		'buttontext' => "Akzeptieren",
		'custom_css' => "",
		'use_stylesheet' => 1,
		'is_active' => 1
	);

	public function init() {
		$this->addHookAfter('Page::render', $this, 'addCookieBanner'); 
	}

	public function addCookieBanner($event) {
		if(!$this->is_active) return;
		
		$page = $event->object; 
		if($page->template == 'admin') return;
		
		if($this->wire('languages')) {
            $userLanguage = $this->wire('user')->language;
            $lang = $userLanguage->isDefault() ? '' : "__$userLanguage->id";
        } else {
            $lang = '';
        }
		
		if(isset($_COOKIE['cmnstr'])){
			return;
		} else {
			$cookieBanner = '<div class="cmnstr">';
			$cookieBanner .= '<div class="cmnstr-body">'.nl2br($this->{"bodytext$lang"}).'</div>';
			$cookieBanner .= '<button class="cmnstr-button" type="button" onclick="setCookieMonster();">'.$this->{"buttontext$lang"}.'</button>';
			$cookieBanner .= '</div>';
			$cookieBanner .= $this->custom_css ? '<style>'.$this->custom_css.'</style>' : '';
			
			$output = $event->return;
			$folder = $this->wire('config')->urls->$this;
			
			// inject stylesheet
			if($this->use_stylesheet){
				$output = str_replace("</head>", "<link rel='stylesheet' type='text/css' href='{$folder}{$this}.css'></head>", $output);
			}
			
			// inject script file
			$output = str_replace("</head>", "<script src='{$folder}{$this}.js'></script></head>", $output);
			
			$regex = '/(<body[^>]*>)/m';
			$replace = '$1'.$cookieBanner;
			
			$event->return = preg_replace($regex, $replace, $output);	
		} 
	}
	
	public static function getModuleConfigInputfields(array $data) {
		$data = array_merge(self::$defaults, $data);
		
		$fields = new InputfieldWrapper();
		$modules = wire('modules');
		
		$field = $modules->get('InputfieldCheckbox');
		$field->label = __('Cookie-Banner aktiviert');
		$field->notes = __('Aktiviert die Anzeige des Cookie-Banners auf allen Seiten.');
		$field->name = 'is_active';
		if(!isset($data['is_active'])){
			$field->attr('checked', 0);
		} else {
			$field->attr('checked', $data['is_active']);
		}
		$field->columnWidth = '50';
		$fields->append($field);
		
		$field = $modules->get('InputfieldCheckbox');
		$field->label = __('CookieMonster-Stylesheet verwenden');
		$field->notes = __('Stellt eine einfache Basis-Formatierung zur Verfügung.');
		$field->name = 'use_stylesheet';
		if(!isset($data['use_stylesheet'])){
			$field->attr('checked', 1);
		} else {
			$field->attr('checked', $data['use_stylesheet']);
		}
		$field->columnWidth = '50';
		$fields->append($field);
		
		$field = $modules->get('InputfieldTextarea');
		$field->label = __('Banner-Text');
		$field->description = __('Der Text des Cookie-Banners');
		$field->notes = __('HTML ist erlaubt, Zeilenumbrüche werden automatisch in <br>-Elemente umgewandelt.');
		$field->attr('name', 'bodytext');
		$field->attr('value', $data['bodytext']);
		$field->columnWidth = '70';
		$field->useLanguages = true;
		$fields->append($field);
		
		$field = $modules->get('InputfieldText');
		$field->label = __('Button-Text');
		$field->description = __('Beschriftung des Buttons');
		$field->attr('name', 'buttontext');
		$field->attr('value', $data['buttontext']);
		$field->columnWidth = '30';
		$field->useLanguages = true;
		$fields->append($field);
		
		$field = $modules->get('InputfieldTextarea');
		$field->label = __('Eigenes CSS');
		$field->description = __('Platz für eigenes CSS');
		$field->notes = __('Die mitgelieferten Styles können hiermit überschrieben werden.');
		$field->attr('name', 'custom_css');
		$field->attr('value', $data['custom_css']);
		$field->columnWidth = '100';
		$fields->append($field);
		
		return $fields;
	}
}
